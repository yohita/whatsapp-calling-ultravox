<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WhatsApp WebRTC Ultravox Bridge</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background-color: #f5f5f5;
    }

    h1 {
      text-align: center;
      margin-top: 50px;
      font-size: 50px;
    }

    p.description {
      text-align: center;
      color: #666;
      max-width: 500px;
      margin: 10px auto 30px;
      font-size: 14px;
    }

    #overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }

    #modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      width: 300px;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      z-index: 1000;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      animation: slideDown 0.3s ease-in-out;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translate(-50%, -60%); }
      to { opacity: 1; transform: translate(-50%, -50%); }
    }

    .modal-header {
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }

    .modal-subtitle {
      font-size: 14px;
      color: #777;
      margin-top: 5px;
    }

    .call-buttons {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }

    .circle-btn {
      width: 60px;
      height: 60px;
      border: none;
      border-radius: 50%;
      font-size: 26px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
    }

    .circle-btn:hover {
      transform: scale(1.1);
    }

    .accept {
      background-color: #28a745;
    }

    .reject {
      background-color: #dc3545;
    }

    #call-timer {
      text-align: center;
      font-size: 18px;
      display: none;
      margin-top: 10px;
    }

    #call-duration-result {
      text-align: center;
      font-size: 18px;
      color: #dc3545;
      margin-top: 10px;
    }

    .ringing {
      animation: pulse 1s infinite ease-in-out;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.3); }
      70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
      100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }
  </style>
</head>
<body>
  <h1>WhatsApp WebRTC Ultravox Bridge</h1>
  <h2 style="text-align: center;"> WhatsApp Business API AI Voice Calling Agent</h2>
  <p class="description">
    This web app is intended to receive incoming WhatsApp API calls.<br>
    When a call arrives Either of 2 options can be taken based on configuration: <br><br>
    1. a modal will appear allowing you to accept or reject it.<br><br>
    2. the call will be automatically accepted.<br>
    Once accepted, a WebRTC connection is established between your browser and the WhatsApp user,
    enabling real-time two-way audio communication using Ultravox.<br>
    Click "Terminate Call" to end the call at any time.
  </p>

  <h2 id="call-status" style="text-align:center; color:#333; font-weight:normal;"></h2>

  <h3 id="active-caller-name" style="text-align:center; color:#555; display:none;"></h3>
  <div id="call-timer">‚è±Ô∏è Call duration: <span id="timer">00:00</span></div>
  <div id="call-duration-result"></div>

  <button id="terminate-btn"
        style="display: none; margin: 10px auto; background-color: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;"
        onclick="terminateCall()">
  Terminate Call
  </button>

  <div id="overlay"></div>
  <div id="modal" class="ringing">
    <div class="modal-header">
      <div class="modal-title" id="caller-name">üì≤ Incoming WhatsApp Call</div>
      <div class="modal-subtitle" id="caller-number"></div>
      <div class="modal-subtitle">Tap to answer or decline</div>
    </div>
    <div class="call-buttons">
      <button class="circle-btn accept" onclick="respond('accept')" title="Accept Call">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="white" viewBox="0 0 24 24">
            <path d="M6.62 10.79a15.053 15.053 0 006.59 6.59l2.2-2.2a1 1 0 011.05-.24 11.72 11.72 0 003.7.59 1 1 0 011 1v3.45a1 1 0 01-1 1A17 17 0 013 5a1 1 0 011-1h3.45a1 1 0 011 1 11.72 11.72 0 00.59 3.7 1 1 0 01-.24 1.05l-2.18 2.2z"/>
          </svg>
        </button>
        <button class="circle-btn reject" onclick="respond('reject')" title="Reject Call">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="white" viewBox="0 0 24 24">
              <path d="M14.4267305,12.3239887 C13.8091494,12.1184418 12.9237465,12.0002 11.9967657,12 C11.0703845,11.9998001 10.1850309,12.1179592 9.56735459,12.323626 C9.29781857,12.4133731 9.10254274,12.5124903 8.99818889,12.5994146 L8.99818886,13.4997844 C8.99830883,14.0560874 8.98526108,14.3378275 8.91482312,14.6766528 C8.76529679,15.3959143 8.36503921,15.9530303 7.5979407,15.9971778 C5.57992549,16.3324217 4.23196922,16.5 3.49954722,16.5 C2.04222339,16.5 1,15.1968274 1,14 L1,12.5 C1,8.77610714 6.02664974,5.99871171 11.9971973,6.00000002 C17.9690798,6.00128863 22.993963,8.77688238 22.9935942,12.4728433 C22.9981103,12.6390833 23.0000363,12.8114009 22.9999995,13.0054528 C22.9999727,13.1468201 22.9992073,13.2587316 22.9969405,13.5090552 C22.9947039,13.7560368 22.993963,13.8651358 22.993963,14 C22.993963,15.1895648 21.9503425,16.5 20.4944157,16.5 C19.7626874,16.5 18.4165903,16.332739 16.4017544,15.9981299 C15.3495506,15.9554142 15.0603932,15.1844357 15.0052983,14.044091 C14.9974219,13.8810653 14.9958289,13.7545264 14.9957743,13.5011312 C14.9956956,12.9832104 14.9956891,12.9405386 14.9957547,12.5995238 C14.8913892,12.5126847 14.6961745,12.4136666 14.4267305,12.3239887 Z M6.99818889,13.5 L6.99818889,12.5 C6.99818889,10.7340787 9.20464625,9.99939745 11.9971973,10 C14.7913808,10.0006029 16.9957741,10.7342819 16.9957741,12.5 C16.9956885,12.9366661 16.9956885,12.9366661 16.995774,13.4997844 C16.995822,13.7225055 16.9971357,13.8268559 17.0029681,13.9475751 C17.0051195,13.992103 17.0078746,14.0335402 17.0110607,14.0715206 C18.7614943,14.3571487 19.9381265,14.5 20.4944157,14.5 C20.7329265,14.5 20.993963,14.1722263 20.993963,14 C20.993963,13.8570865 20.9947313,13.7439632 20.9970225,13.4909448 C20.9992358,13.2465315 20.9999742,13.1385601 20.9999995,13.0050735 C21.0000331,12.8280282 20.998305,12.6734088 20.993963,12.5 C20.993963,10.2010869 17.0111151,8.00108196 11.9967657,7.99999998 C6.98400975,7.99891833 3,10.2002196 3,12.5 L3,14 C3,14.1781726 3.2573842,14.5 3.49954722,14.5 C4.05591217,14.5 5.23278898,14.3571098 6.98361703,14.071404 C6.99451507,13.9374564 6.99824508,13.76066 6.99818889,13.5 Z"></path>
            </svg>
        </button>
    </div>
  </div>

  <script>
    const socket = io();
    let pc;
    let callStartTime = null;
    let timerInterval = null;
    let localStream = null;
    let activeCallerName = "";
    let incomingCallId = "";
    const callStatusEl = document.getElementById("call-status");

    function startCallTimer() {
      callStartTime = Date.now();
      document.getElementById("call-timer").style.display = "block";

      timerInterval = setInterval(() => {
        const elapsedMs = Date.now() - callStartTime;
        const seconds = Math.floor(elapsedMs / 1000);
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        document.getElementById("timer").textContent =
          `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }, 1000);
    }

    function stopCallTimer() {
      clearInterval(timerInterval);
      timerInterval = null;

      const elapsedMs = Date.now() - callStartTime;
      const seconds = Math.floor(elapsedMs / 1000);
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;

      const duration = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      document.getElementById("call-timer").style.display = "none";
      document.getElementById("call-duration-result").textContent =
        `üì¥ Call ended. Duration: ${duration}`;
    }

    socket.on("call-is-coming", ({ callId, callerName, callerNumber }) => {
      console.log("WhatsApp call detected:", callId);
      activeCallerName = callerName;
      incomingCallId = callId;

      document.getElementById("caller-name").textContent = "üì≤ Incoming WhatsApp Call";
      document.getElementById("caller-number").textContent = `${callerName} (${callerNumber})`;

      callStatusEl.textContent = "üì≤ Incoming WhatsApp Call...";
      document.getElementById("modal").style.display = "block";
      document.getElementById("overlay").style.display = "block";
    });

    socket.on("start-browser-timer", () => {
      console.log("Call accepted ‚Äî starting timer.");
      startCallTimer();
    });

    socket.on("call-ended", () => {
      console.log("Call ended by server.");
      callStatusEl.textContent = "WhatsApp API Call";
      document.getElementById("active-caller-name").style.display = "none";
      stopCallTimer();

      if (pc) {
        pc.close();
        pc = null;
      }

      callStatusEl.textContent = "";
      document.getElementById("active-caller-name").style.display = "none";
      document.getElementById("terminate-btn").style.display = "none";

      // Remove any dynamic audio elements
      document.querySelectorAll("audio").forEach(audio => audio.remove());
    });

    socket.on("browser-answer", async (sdp) => {
      await pc.setRemoteDescription(new RTCSessionDescription({ type: "answer", sdp }));
    });

    socket.on("browser-candidate", async (candidate) => {
      await pc.addIceCandidate(new RTCIceCandidate(candidate));
    });


    function terminateCall() {
      console.log("Call manually terminated.");

      // Notify backend if needed
      socket.emit("terminate-call", incomingCallId);

      // Reset UI
      callStatusEl.textContent = "";
      document.getElementById("active-caller-name").style.display = "none";
      document.getElementById("terminate-btn").style.display = "none";

      stopCallTimer();

      // Cleanup WebRTC connection
      if (pc) {
        pc.close();
        pc = null;
      }

      // Remove any dynamic audio elements
      document.querySelectorAll("audio").forEach(audio => audio.remove());
    }

    function respond(choice) {
      document.getElementById("modal").style.display = "none";
      document.getElementById("overlay").style.display = "none";

      if (choice === "accept") {
        callStatusEl.textContent = "üî¥ In Call";
        document.getElementById("active-caller-name").textContent = `With ${activeCallerName}`;
        document.getElementById("active-caller-name").style.display = "block";
        document.getElementById("call-duration-result").textContent = "";
        document.getElementById("terminate-btn").style.display = "block";

        startWebRTC();
      } else {
        socket.emit("reject-call", incomingCallId);
        callStatusEl.textContent = "";
        document.getElementById("active-caller-name").style.display = "none";
      }
    }

    async function startWebRTC() {
      pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.relay.metered.ca:80" }],
      });

      // Handle incoming audio from WhatsApp
      pc.ontrack = (e) => {
        const audio = new Audio();
        audio.srcObject = e.streams[0];
        audio.autoplay = true;
        document.body.appendChild(audio);
      };

      // Send ICE candidates to the backend
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          socket.emit("browser-candidate", event.candidate);
        }
      };

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(track => pc.addTrack(track, stream));

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit("browser-offer", offer.sdp);      
    }
  </script>

  <h3 style="text-align:center">Yohita</h3>
</body>
</html>
